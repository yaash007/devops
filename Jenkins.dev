pipeline {
    agent any

    stages {
        stage('Checkout Code') {
            steps {
                checkout([$class: 'GitSCM', branches: [[name: '*/main']],
                userRemoteConfigs: [[url: 'https://github.com/yaash007/devops.git']]])
            }
        }

        stage('Install Nginx If Needed') {
            steps {
                sh '''
                if ! command -v nginx &> /dev/null
                then
                    echo "Installing nginx..."
                    sudo apt update -y
                    sudo apt install nginx -y
                else
                    echo "Nginx already installed."
                fi
                '''
            }
        }

        stage('Deploy Website Files') {
            steps {
                sh '''
                echo "Cleaning old files..."
                sudo rm -rf /var/www/html/*

                echo "Copying new index.html..."
                sudo cp -f index.html /var/www/html/index.html

                echo "Deployment completed."
                '''
            }
        }

        stage('Restart Nginx') {
            steps {
                sh '''
                echo "Restarting nginx..."
                sudo systemctl restart nginx

                echo "===== NGINX STATUS ====="
                sudo systemctl status nginx --no-pager
                '''
            }
        }

        stage('Verify Deployment') {
            steps {
                sh '''
                echo "===== Files in /var/www/html ====="
                ls -ltr /var/www/html

                echo "===== Checking website output ====="
                curl -I localhost
                '''
            }
        }
    }
}
